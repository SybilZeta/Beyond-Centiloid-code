name: Build CentiloidCalculator

on: [push, pull_request]

env:
  ONNXRUNTIM_VERSION: 1.20.1

jobs:
  build-windows:
    name: Build on Windows
    runs-on: windows-2022
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1
      - name: Install vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 'e7c6e4b4b8f8e5b1b8b8e5b1b8b8e5b1b8b8e5b1'  # 替换为实际 SHA1
      - name: Install dependencies via vcpkg
        run: |
          .\vcpkg\vcpkg install itk simpleitk onnxruntime
      - name: Build with CMake
        run: |
          cmake -S cpp -B build -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}\vcpkg\scripts\buildsystems\vcpkg.cmake
          cmake --build build --config Release
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CentiloidCalculator-windows
          path: build/Release/CentiloidCalculator.exe

  build-macos:
    name: Build on macOS
    runs-on: macOS-12
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install ITK and SimpleITK via Homebrew
        run: |
          brew install itk simpleitk
      - name: Download ONNX Runtime binary
        run: |
          curl -L -o onnxruntime.tar.gz "https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ONNXRUNTIM_VERSION }}/onnxruntime-osx-x64-${{ env.ONNXRUNTIM_VERSION }}.tgz"
          tar -xzf onnxruntime.tar.gz
      - name: Set extracted directory name
        run: |
          EXTRACTED_DIR=onnxruntime-osx-x64-${{ env.ONNXRUNTIM_VERSION }}
          echo "EXTRACTED_DIR=$EXTRACTED_DIR" >> $GITHUB_ENV
      - name: Build with CMake
        run: |
          cmake -S cpp -B build -DCMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/${{ env.EXTRACTED_DIR }}
          cmake --build build --config Release
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CentiloidCalculator-macos
          path: build/CentiloidCalculator

  build-linux:
    name: Build on Linux
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install ITK and SimpleITK
        run: |
          sudo apt-get update
          sudo apt-get install -y libinsighttoolkit4-dev libsimpleitk1-dev
      - name: Download ONNX Runtime binary
        run: |
          curl -L -o onnxruntime.tar.gz "https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ONNXRUNTIM_VERSION }}/onnxruntime-linux-x64-${{ env.ONNXRUNTIM_VERSION }}.tgz"
          tar -xzf onnxruntime.tar.gz
      - name: Set extracted directory name
        run: |
          EXTRACTED_DIR=onnxruntime-linux-x64-${{ env.ONNXRUNTIM_VERSION }}
          echo "EXTRACTED_DIR=$EXTRACTED_DIR" >> $GITHUB_ENV
      - name: Build with CMake
        run: |
          cmake -S cpp -B build -DCMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/${{ env.EXTRACTED_DIR }}
          cmake --build build --config Release
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CentiloidCalculator-linux
          path: build/CentiloidCalculator